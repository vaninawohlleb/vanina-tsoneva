<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>BrightAct</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700=swap" rel="stylesheet">
    <link href="data-viz.css" rel="stylesheet" type="text/css">
  </head>

  <body class="data-viz">
    <hgroup>
      <h1>
        Domestic Violence by percentage, by EU state
      </h1>
      <p class="info__detail">Women who have experienced physical and/or sexual violence by current and/or previous
        partner, since the age of 15. Data from <a
          href="https://fra.europa.eu/sites/default/files/fra_uploads/fra-2014-vaw-survey-main-results-apr14_en.pdf"
          target="blank">FRA research</a> from 2012</p>
    </hgroup>
    <div class="map">
      <div id="map-legend" class="map__legend"></div>
      <div id="map-chart" class="map__chart"></div>  
    </div>
  </body>

  <!-- Amcharts  -->
  <script src="https://www.amcharts.com/lib/4/core.js"></script>
  <script src="https://www.amcharts.com/lib/4/maps.js"></script>
  <script src="https://www.amcharts.com/lib/4/geodata/worldLow.js"></script>
  <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

  <script type="text/javascript">
    am4core.ready(function() {
      am4core.useTheme(am4themes_animated);
      var map = am4core.create('map-chart', am4maps.MapChart);
      map.geodata = am4geodata_worldLow;
      map.projection = new am4maps.projections.Miller();

      map.homeZoomLevel = 3;
      map.homeGeoPoint = {
        latitude: 52,
        longitude: 10
      };

      // Polygon Series
      var polygonSeries = map.series.push(new am4maps.MapPolygonSeries());;
      polygonSeries.useGeodata = true;
      polygonSeries.exclude = ['AQ'];
      polygonSeries.nonScalingStroke = true;
      polygonSeries.strokeWidth = 0.1;
      polygonSeries.calculateVisualCenter = true;

      // Configure map visual
      var polygonTemplate = polygonSeries.mapPolygons.template;
      // polygonTemplate.tooltipText = "{name}";
      polygonTemplate.fill = am4core.color('#454553');
      polygonTemplate.stroke = am4core.color('#A4A4A9');
      map.backgroundSeries.mapPolygons.template.polygon.fill = am4core.color("#35353F");
      map.backgroundSeries.mapPolygons.template.polygon.fillOpacity = 1;

      // bubbles and external data
      var imageSeries = map.series.push(new am4maps.MapImageSeries());
      imageSeries.dataSource.url = '/data-viz/violence_by_country.json'; 
      imageSeries.dataFields.value = "value";

      // Configure bubble visual
      var imageTemplate = imageSeries.mapImages.template;
      imageTemplate.nonScaling = true;

      var circle = imageTemplate.createChild(am4core.Circle);
      circle.fillOpacity = 0.7;
      circle.fill = am4core.color("#FC5E2F");
      circle.tooltipText = "{country}: [bold]{value}%[/]";
      imageSeries.tooltip.getFillFromObject = false;
      imageSeries.tooltip.background.fill = am4core.color("#35353F");
      imageSeries.tooltip.label.fill = am4core.color("#fff");

      imageSeries.heatRules.push({
        "target": circle,
        "property": "radius",
        "min": 8,
        "max": 35,
        "dataField": "value"
      })
      
      // Add latitude and longitude
      imageTemplate.adapter.add("latitude", function (latitude, target) {
        var polygon = polygonSeries.getPolygonById(target.dataItem.dataContext.id);
        if (polygon) {
          return polygon.visualLatitude;
        }
        return latitude;
      })

      imageTemplate.adapter.add("longitude", function (longitude, target) {
        var polygon = polygonSeries.getPolygonById(target.dataItem.dataContext.id);
        if (polygon) {
          return polygon.visualLongitude;
        }
        return longitude;
      })
      
      // Zoom
      map.zoomControl = new am4maps.ZoomControl();
      
      // Hover on country
      var hoverState = polygonTemplate.states.create('hover');
      hoverState.properties.fill = am4core.color('#35353F');

      // Legend
      var legendContainer = am4core.create("map-legend", am4core.Container);
      legendContainer.width = am4core.percent(100);
      legendContainer.height = am4core.percent(100);

      map.legend = new am4maps.Legend();
      map.legend.dataSource.url = imageSeries.dataSource.url;
      map.legend.position = "absolute";
      map.legend.parent = legendContainer;
      map.legend.scrollable = true;
      map.legend.maxWidth = "100";
      map.legend.markers.template.disabled = true;

      map.legend.labels.template.text = "{country}:";
      map.legend.labels.template.fill = am4core.color('#fff');
      map.legend.valueLabels.template.text = "{value}%";
      map.legend.valueLabels.template.fill = am4core.color('#FC5E2F');
      map.legend.valueLabels.template.align = "left";
      map.legend.valueLabels.template.textAlign = "start";
      map.legend.itemContainers.template.paddingTop = 5;
      map.legend.itemContainers.template.paddingBottom = 5;

      map.legend.itemContainers.template.events.on("toggled", function(event) {
        var item = event.target;

        imageSeries.dataItems.each(function (row, i) {
          if (item.isActive && item.dataItem.dataContext.country === row.dataContext.country) { 
            map.zoomToGeoPoint(row.geoPoint, 20, true);
            circle.fill = am4core.color("#fff");
          } else if (!item.isActive) {
          //  map.zoomToGeoPoint(map.homeGeoPoint, 3);

          }
        })
      })
    })
  </script>
</html>